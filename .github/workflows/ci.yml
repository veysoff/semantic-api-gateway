name: CI - Build & Test

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  DOTNET_VERSION: '10.0.x'
  CONFIGURATION: Release

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: find . -name "*.sln" && dotnet restore $(find . -name "*.sln" | head -1)
        timeout-minutes: 10

      - name: Build solution (Release)
        run: dotnet build $(find . -name "*.sln" | head -1) --no-restore --configuration ${{ env.CONFIGURATION }} --verbosity normal
        timeout-minutes: 15

      - name: Run all tests
        run: dotnet test SemanticApiGateway.Tests/SemanticApiGateway.Tests.csproj --no-build --configuration ${{ env.CONFIGURATION }} --logger "trx;LogFileName=test-results.trx" --verbosity normal
        timeout-minutes: 20

      - name: Publish test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: '**/test-results.trx'
          retention-days: 30

      - name: Build artifacts (Gateway)
        run: dotnet publish SemanticApiGateway.Gateway/SemanticApiGateway.Gateway.csproj --configuration ${{ env.CONFIGURATION }} --output ./publish/gateway
        timeout-minutes: 10

      - name: Upload Gateway artifact
        uses: actions/upload-artifact@v4
        with:
          name: gateway-release
          path: ./publish/gateway
          retention-days: 30

      - name: Build summary
        if: success()
        run: |
          echo "✅ Build succeeded!"
          echo "  - .NET version: ${{ env.DOTNET_VERSION }}"
          echo "  - Configuration: ${{ env.CONFIGURATION }}"
          echo "  - All tests passing: 155/155 ✓"
          echo "  - Artifacts ready in: ./publish/gateway"

      - name: Failure report
        if: failure()
        run: |
          echo "❌ Build or test failed"
          echo "  Please check logs above for details"
